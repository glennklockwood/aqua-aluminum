# My Personal Website

This repository contains all of the content and tooling used to generate my
personal website, https://www.glennklockwood.com/.  The site used to be
[Hugo][]-based but I switched to [Pelican][] since don't really use Go, find the
Go templating engine idiosyncratic, and I wind up using a lot more Python these
days.

There is a fair amount of site-specific devilry baked into this site which is
implemented in the included `limeleadlib` Python library.

[Hugo]: https://gohugo.io/
[Pelican]: https://getpelican.com/

## Requirements

See `requirements.txt`.  The following packages are noteworthy:

- pelican: Framework that provides the Markdown-to-HTML rendering environment
- markdown: Contents are all expressed in Markdown rather than RST
- bs4: Required by some plugins to hack HTML that Pelican (Markdown) generates
- pandas: Required to draw benchmarking performance data tables
- tabulate: Also required to draw benchmarking performance data tables
- yaml: Directory metadata is expressed in YAML files

Setting up the environment on Raspberry Pi is straightforward:

    $ sudo apt-get install python3-virtualenv python3-pandas python3-yaml \
                           python3-tabulate python3-markdown python3-bs4
    $ virtualenv -p python3 --system-site-packages pelican
    # 
    $ . pelican/bin/activate
    $ pip3 install -r requirements.txt

For newer distributions with newer Pythons, you may need to use the following
instead to set up a virtualenv:

    $ python3 -mvenv --system-site-packages pelican

You can also skip installing the dependency packages (pandas, yaml, markdown,
etc) from the Raspbian repo and `pip3 install` them yourself.  However the above
process allows you to skip the long, onerous build of Pandas that is otherwise
required.

## Common Operations

This website uses Pelican as a foundation for providing the directory structure
and rendering interfaces, but there are a lot of site-specific operations that
require understanding the specific way in which limeleadlib and the _molecular_
theme extend Pelican.

### Editing the Landing Page

The text on the landing page (index.html) is rendered from
`content/pages/index.md` so just edit that.

### Adding New Pages

You can easily add new pages to any of the subdirectories in `contents/pages/`
in Markdown format and Pelican will find them, render them, and link them into
both its containing directory's index and the top-level page.  For example,
creating `contents/pages/data-intensive/dask.md` will

1. Add a link to that new page in the final `/data-intensive/index.html`
2. Add a link to that new page in `/index.html`

All new pages _must_ have the following metadata header at the top:

    ---
    title: Long-form title of page
    ---

The three dashes before and after are absolutely required or else the page will
not render.  Beyond that though, there are a few other metadata tags you can
optionally add in YAML format:

- _shortTitle_: An abbreviated page title, used in the breadcrumb
- _order_: Any number.  This is used to sort the pages when building directory
  index pages; useful if there is a natural ordering of pages in a directory.

You may also include whatever other metadata you want.

### Adding New Directories

If you want to add a new section entirely to the website,

1. Make a new subdirectory in `contents/pages/`
2. (Optional): Create a file called `_metadata.yml` in that directory with,
   at minimum, a `title` key
3. Create a page in that subdirectory with some content
4. Edit `themes/molecular/templates/index.html` and insert a call to the
   `make_index_html_ul()` function

The `_metadata.yml` file is directory-level metadata.  If this file exists, it
_must_ contain the `title` key.  It may also optionally contain

- `content`: A string that is prepended to the `index.html` that is created for
  that directory.  It should be expressed in Markdown.
- `contentHtml`: A string that is prepended to the bulleted list of this
  directory's contents when generated by `make_index_html_ul()`.  It should be
  expressed as HTML and be wrapped in `<p>` tags.

The `make_index_html_ul()` Jinja2 function is provided by the
`limeleadlib.index` plugin and generates a bulleted list of a directory's assets
(subdirectories and pages).  That function's docstring describes the arguments
it expects.

### Building

To build the site, use

    $ SITEURL=http://127.0.0.1:8000 make clean html devserver PORT=8000

Pelican will then serve the site at http://localhost:8000/ and update whenever
changes to the markdown are detected.

### Publishing

To publish the site, use

    $ make publish rsync_upload

The rsync/ssh host and destination directory parameters are baked into
`Makefile`.

## Jinja2 Shortcodes

This website uses several forms of shortcodes and are implemented in the
`limelead.jinja2content` plugin.  This plugin allows Jinja2 to be resolved
within Markdown files with the limitation that the Pelican context is generally
_not_ available to Jinja2 when using these, so these shortcodes must be pure
(without side effects).

Some shortcodes are implemented as Jinja2 macros and are used to decorate a blob
of Markdown with special div decorations, e.g.,

    {% call alert(type="info") %}
    Some _markdown_ goes [here](index.html).
    {% endcall %}

The contents of these info boxes get rendered as standalone Markdown documents, so be sure any links referenced therein are also within the call/endcall.

The second form are Jinja2 filters and are used in Jinja2 templates since they
typically modify something from the Pelican context, e.g.,

    {{ page.source_path | getmtime }}

There are also some functions which are exposed from Python into Jinja2 which
can be called outright, e.g.,

    {{ json2table('path/to/table.json') }}

The `limeleadlib.jinja2content` explicitly imports the filters and functions
defined in `limeleadlib.filters` plugin so that they are available inside of
Markdown documents.

### Validation

Any time CSS is changed, consider visually inspecting the following files for
the functionality of some special features:

- `content/pages/electronics/bmc2835-gpio.md`
    - figure
    - alert shortcode (info)
    - numbered pre blocks (using `#!text`)
