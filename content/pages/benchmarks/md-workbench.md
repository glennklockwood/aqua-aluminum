---
title: Getting Started with md-workbench
shortTitle: md-workbench
---

{% call alert(type="info") %}
This page remains a work in progress.
{% endcall %}

{% call alert(type="warning") %}
Do not run md-workbench with the default parameters because they reflect a
benchmark that will run for a very long time.
{% endcall %}

md-workbench generates a semi-synchronous metadata-intensive workload that was
designed to mimic what a parallel compilation may look like to a file system.
It runs in three phases which are described below.

Let's take a look at what a simple md-workbench does:

    mpirun -n 2 md-workbench -I 7 -P 11 -D 3

According to the manual,

- `-I` is the number of "objects" (files) to manipulate per "data set" (directory)
- `-P` is the number of objects to precreate per data set
- `-D` is the number of data sets to manipulate per process

## Phase 1 - Precreate phase

This phase can be isolated by specifying the `-1` or `--run-precreate` option.

Rank 0 does

- `mkdir out/0_0`
- `mkdir out/0_1`
- `mkdir out/0_2`

and rank 1 does

- `mkdir out/1_0`
- `mkdir out/1_1`
- `mkdir out/1_2`

Then rank 0 creates a bunch of files:

- `open(out/0_0/file-0, O_CREAT)`
- write 3901 bytes to this file
- close this file
- ...
- `open(out/0_0/file-10, O_CREAT)`
- write 3901 bytes to this file
- close this file

then repeat this for `out/0_1` and `out/0_2`.

Then there's a barrier.

As you can see, we created three directories per rank because of `-D 3` and
eleven files per directory because of `-P 11`.  The `-I 7` does not play a role
here.

The 3901-byte file size can be changed using `-S` or `--object-size`, and this
phase can be run multiple times using `-R` or `--iterations`.

## Phase 2 - Benchmark phase

This phase can be isolated by specifying the `-2` or `--run-benchmark` option.

Rank 0 does:

- `stat(out/1_0/file-0)`
- `open(out/1_0/file-0)`
- read 3901 bytes from `$WORKDIR/out/1_0/file-0` - this is an absolute path,
  not a relative one
- `close($WORKDIR/out/1_0/file-0)`
- `unlink(./out/1_0/file-0)`

- `open(./out/1_0/file-10, O_CREAT)`
- write 3901 bytes to `$WORKDIR/out/1_0/file-10`
- `close($WORKDIR/out/1_0/file-10)`

This is repeated for `file-0` and `file-10` in different directories for a total
of 21 times, or `-I` times `-D`.  This is to say, for each directory:

1. a file is statted, opened, read, closed, and deleted
2. a new file is created written, and closed

There is no net creation or destruction of files, but files are being created
and destroyed repeatedly.  The mapping of MPI ranks to directories/files here is
shuffled relative to Phase 1.  Stay tuned for more information on how this
shuffling is determined.

Then there's a barrier.

Note that `-P` plays no role here; it is solely for Phase 1.  However the first
round of open-read-close-unlink in Phase 2 depends on precreated files which are
generated by Phase 1, so you should make sure that `-P` is the same as `-I`.  If
you don't do this, Phase 2 will try to open files that weren't precreated and
categorize these operations as errors on the first round (but will then happily
proceed).

## Phase 3 - Cleanup phase

This phase can be isolated by specifying the `-3` or `--run-cleanup` option.

Rank 0:

- unlinks the seven files in `./out/0_0/`
- `rmdir(./out/0_0/)`

Repeat for `0_1/` and `0_2/`.

Rank 1 does the same for its directories and files from Phase 1.
